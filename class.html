<!DOCTYPE html>
<html lang="ko" dir="ltr">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.2/css/bootstrap.min.css" integrity="sha384-Smlep5jCw/wG7hdkwQ/Z5nLIefveQRIY9nfy6xoR1uRYBtpZgI6339F5dgvm/e9B" crossorigin="anonymous">
  <link rel="stylesheet" href="style.css">
  <link rel="shortcut icon" href="elf logo_transparent.png">
  <script src="https://cdn.jsdelivr.net/npm/js-cookie@2/src/js.cookie.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.2/js/bootstrap.min.js" integrity="sha384-o+RDsa0aLu++PJvFqy8fFScvbHFLtbvScb8AjopnFD+iEQ7wo/CG0xlczd+2O/em" crossorigin="anonymous"></script>
  <script src="https://www.gstatic.com/firebasejs/5.2.0/firebase.js"></script>
  <script src="core.js"></script>
  <script>
    // Initialize Firebase
    var config = {
      apiKey: "AIzaSyB1yfyT_PozgicExEjiN9yuvtNBIyZwc64",
      authDomain: "elf-171bb.firebaseapp.com",
      databaseURL: "https://elf-171bb.firebaseio.com",
      projectId: "elf-171bb",
      storageBucket: "",
      messagingSenderId: "550791088476"
    };
    firebase.initializeApp(config);
    var db = firebase.firestore();
    const settings = {
      timestampsInSnapshots: true
    };
    db.settings(settings);
  </script>
  <title>Elf</title>
</head>

<body>
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
    <a class="navbar-brand" href="index.html">Elf <span class="badge badge-secondary">Beta</span> </a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
    <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
      <ul class="navbar-nav mr-auto">
        <li class="nav-item">
          <a class="nav-link" href="index.html">Home</a>
        </li>
        <li class="nav-item active">
          <a class="nav-link" href="#">Class</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="intro.html">What is Elf?</a>
        <li class="nav-item">
          <a class="nav-link" href="crashreport.html">Crash report</a>
      </ul>
      <form class="form-inline my-2 my-lg-0">
        <button class="btn btn-outline-warning btn-block my-2 my-sm-0" type="button" id="SignInandSetting">Sign In</button>
      </form>
    </div>
  </nav>
  <div class="container-fluid">
    <div class="row align-items-center" id="default_row">
      <div class="col"></div>
      <div class="col-10">
        <h1 class="display-4">Class Management</h1>
        <p class="lead">Join, Create and Share!!</p>
        <button type="button" class="btn btn-dark btn-block mb-3" id="CreateClass">Create Class</button>
        <button type="button" class="btn btn-dark btn-block mb-3" id="JoinClass">Join Class</button>
        <button type="button" class="btn btn-dark btn-block" id="EnterClass">Enter Class</button>
      </div>
      <div class="col"></div>
    </div>
  </div>
  <div class="modal fade" id="CCModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Create Class</h5>
        </div>
        <div class="modal-body">
          <div class="input-group">
            <input type="text" class="form-control" placeholder="Class Name" id="Name_CC">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-dark" id="RealCC">Create Class</button>
        </div>
      </div>
    </div>
  </div>
  <div class="modal fade" id="JCModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Join Class</h5>
        </div>
        <div class="modal-body">
          <div class="input-group mb-3">
            <input type="text" class="form-control" placeholder="Class ID" id="ID_JC">
          </div>
          <div class="input-group">
            <input type="password" class="form-control" placeholder="Teacher Token" id="Token_JC">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-dark" id="RealJC">Join Class</button>
        </div>
      </div>
    </div>
  </div>
  <div class="modal fade" id="ECModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Enter Class</h5>
        </div>
        <div class="modal-body">
          <table class="table table-bordered">
            <thead>
              <tr>
                <th scope="col">#</th>
                <th scope="col">Name</th>
                <th scope="col">Go</th>
              </tr>
            </thead>
            <tbody>
              <!--
              <tr>
                <th scope="row">1</th>
                <td>Mark</td>
                <td>Otto</td>
                <td>@mdo</td>
              </tr>
              -->

            </tbody>
          </table>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
        </div>
      </div>
    </div>
  </div>
</body>
<script type="text/javascript">
  $('#CCModal>input').keyup(function(e) {
    if (e.keyCode === 13) $("#RealCC").click();
  });
  $('#JCModal>input').keyup(function(e) {
    if (e.keyCode === 13) $("#RealJC").click();
  });
  var gentoken = function() {
    return Math.random().toString(36).substr(2); // remove `0.`
  };
  var enterclass=function(k){
    Cookies.set('_classid', k);
    window.location.replace('class_info.html');
  }
  $("#SignInandSetting").click(function() {
    if (firebase.auth().currentUser != null) {
      window.location.replace('usersetting.html')
    } else {
      window.location.replace('signin.html')
    }
  });
  firebase.auth().onAuthStateChanged(function(user) {
    if (user) {
      if(!user.emailVerified) {
        alert("Please verify your email first.")
        window.location.replace("usersetting.html");
      }
      db.collection("Users").doc(user.uid).get.then(function(doc) {
  if(doc.data().hasOwnProperty("alerts")) $("#SignInandSetting").html(user.displayName+"<span class=\"badge badge-warning ml-2\">"+doc.data()["alerts"].length+"</span>");
  else $("#SignInandSetting").html(user.displayName+"<span class=\"badge badge-warning ml-2>0</span>");
});
      if (user.photoURL === "Student") {
        $("#CreateClass").css({'display':'none'});
      }
      getClassList(function(k) {
        getTable(k, function(tbl) {
          $("#ECModal>.modal-dialog>.modal-content>.modal-body>table>tbody").html(tbl);
        });
      });
    } else {
      alert("Please sign in first.")
      window.location.replace("signin.html");
    }
  });
  var getClassList = function(callback) {
    var classesRef = db.collection('Users').doc(firebase.auth().currentUser.uid);
    classesRef.get().then(function(doc) {
      if (doc.exists) {
        if (doc.data().hasOwnProperty("Classes")) {
          callback(doc.data()["Classes"]);
        } else {
          callback([]);
        }
      } else {
        console.log("No such document!");
      }
    }).catch(function(error) {
      var errorMessage = error.message;
      alert(errorMessage);
    });
  }
  var getTable = function(IDList, callback) {
    var TBLE = "";
    var cnt=0, cnt2=0;
    for(var i=0;i<IDList.length;i++) {
      db.collection('Classes').doc(IDList[i]).get().then(function(doc) {
        if(doc.exists) {
          if(doc.data()["parent"]=="") {
            TBLE=TBLE+"<tr><th scope=\"row\">"+(cnt+1).toString()+"</th><td>"
                +doc.data()['name']+"</td><td><button type=\"button\" class=\"btn btn-dark btn-sm btn-block\" onclick=\"enterclass(\'"
                +IDList[cnt2]+"\')\">Go!"
                +"</button></td></tr>";
            console.log(TBLE);
            cnt++;
          }
          cnt2++;
          if(cnt2===IDList.length) callback(TBLE);
        }
      }).catch(function(error) {
        var errorMessage = error.message;
        alert(errorMessage);
      });
    }
  }
  $("#CreateClass").click(function() {
    if (firebase.auth().currentUser.photoURL === "Student") {
      alert("Student cannot create classes.");
      return;
    }
    $("#CCModal").modal();
  });
  $("#RealCC").click(function() {
    var user = firebase.auth().currentUser;
    var classname = $("#Name_CC").val();
    var ds = (new Date()).toISOString().replace(/[^0-9]/g, "") + "_" + gentoken();
    db.collection("Classes").doc(ds).set({
      name: classname,
      teacher_token: gentoken(),
      members: {
        TeacherName: [user.displayName],
        TeacherUid: [user.uid],
        StudentName: [],
        StudentUid: []
      },
      childs:[],
      parent:""
    }).then(function() {
      var Ref = db.collection("Users").doc(user.uid);
      Ref.get().then(function(doc) {
        var classList = [];
        if (doc.exists) {
          if (doc.data().hasOwnProperty("Classes")) {
            classList = doc.data()["Classes"];
          }
        }
        console.log(classList);
        classList.push(ds);
        Ref.set({
          username: user.displayName,
          Classes: classList
        }, {
          merge: true
        }).then(function() {
          alert('Class creation complete.')
          enterclass(ds);
        }).catch(function(error) {
          var errorMessage = error.message;
          alert(errorMessage);
        });
      }).catch(function(error) {
        var errorMessage = error.message;
        alert(errorMessage);
      });
    }).catch(function(error) {
      var errorMessage = error.message;
      alert(errorMessage);
    });
  });
  $("#JoinClass").click(function() {
    var user = firebase.auth().currentUser;
    if (user.photoURL === "Student") {
      $("#Token_JC").attr('style', 'display:none;');
      $("#Real_JC").attr('class', 'input-group');
    }
    $("#JCModal").modal();
  });
  $("#RealJC").click(function() {
    var user = firebase.auth().currentUser;
    var Ttoken = $("#Token_JC").val();
    var classID = $("#ID_JC").val();
    var Ref = db.collection("Classes").doc(classID);
    var docdata;
    Ref.get().then(function(doc) {
      if (doc.exists) {
        docdata = doc.data();
        if (user.photoURL === "Student") {
          if (docdata["members"]["StudentUid"].includes(user.uid)) {
            alert("You already joined this class!")
            return;
          }
          docdata["members"]["StudentName"].push(user.displayName);
          docdata["members"]["StudentUid"].push(user.uid);
        } else {
          if (Ttoken != docdata["teacher_token"]) {
            alert("Enter the token properly.");
            return;
          }
          if (docdata["members"]["TeacherUid"].includes(user.uid)) {
            alert("You already joined this class!");
            return;
          }
          docdata["members"]["TeacherName"].push(user.displayName);
          docdata["members"]["TeacherUid"].push(user.uid);
        }
        Ref.update({
          members: {
            TeacherName: docdata["members"]["TeacherName"],
            TeacherUid: docdata["members"]["TeacherUid"],
            StudentName: docdata["members"]["StudentName"],
            StudentUid: docdata["members"]["StudentUid"]
          }
        }).then(function() {
          var Ref = db.collection("Users").doc(user.uid);
          var classList = [];
          Ref.get().then(function(doc) {
            if (doc.exists) {
              if (doc.data().hasOwnProperty("Classes")) {
                classList = doc.data()["Classes"];
              }
            }
            classList.push(classID);
            Ref.set({
              username: user.displayName,
              Classes: classList
            }, {
              merge: true
            }).then(function() {
              alert('Class joining complete.')
              enterclass(classID);
            }).catch(function(error) {
              var errorMessage = error.message;
              alert(errorMessage);
            });
          }).catch(function(error) {
            var errorMessage = error.message;
            alert(errorMessage);
          });
        }).catch(function(error) {
          var errorMessage = error.message;
          alert(errorMessage);
        });
      } else {
        alert("No class. Please check again.");
      }
    }).catch(function(error) {
      var errorMessage = error.message;
      alert(errorMessage);
    });
  });
  $("#EnterClass").click(function(){
    $("#ECModal").modal();
  });
</script>

</html>
